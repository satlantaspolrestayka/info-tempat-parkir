name: Process Parking Updates (Optimized)

on:
  schedule:
    - cron: '*/5 * * * *'  # Changed: 5 minutes instead of 2 to avoid rate limits
  
  workflow_dispatch:
    inputs:
      force:
        description: 'Force process all pending updates'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  process-updates:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package.json'
        
    - name: Install dependencies
      run: |
        npm ci --only=production
        npm list --depth=0
        
    - name: Check for pending updates
      id: check-updates
      run: |
        # Create initial files if they don't exist
        if [ ! -f "data/pending-updates.json" ]; then
          echo '[]' > data/pending-updates.json
        fi
        
        if [ ! -f "data/parkir-data.json" ]; then
          echo '{"locations":[],"statistics":{},"metadata":{}}' > data/parkir-data.json
        fi
        
        # Count pending updates
        PENDING_COUNT=$(node -e "
          const fs = require('fs');
          try {
            const updates = JSON.parse(fs.readFileSync('data/pending-updates.json', 'utf8'));
            const pending = updates.filter(u => 
              !u.processed_at && u.status !== 'processed' && u.status !== 'failed'
            );
            console.log(pending.length);
          } catch(e) {
            console.log(0);
          }
        ")
        
        echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
        if [ "$PENDING_COUNT" -gt 0 ]; then
          echo "has_pending=true" >> $GITHUB_OUTPUT
        else
          echo "has_pending=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Skip if no updates
      if: steps.check-updates.outputs.has_pending == 'false' && github.event.inputs.force != 'true'
      run: |
        echo "‚è≠Ô∏è No pending updates to process"
        exit 0
        
    - name: Process updates
      if: steps.check-updates.outputs.has_pending == 'true' || github.event.inputs.force == 'true'
      id: process
      continue-on-error: true
      env:
        FORCE_PROCESS: ${{ github.event.inputs.force || 'false' }}
      run: |
        echo "üöó Processing parking data updates..."
        
        # Run the update processor
        node scripts/process-updates.js
        
        # Capture output using new GitHub Actions format
        PROCESSED_COUNT=$(grep "::set-output name=processed_count::" <<< "$(node scripts/process-updates.js 2>&1)" | cut -d: -f4 || echo "0")
        FAILED_COUNT=$(grep "::set-output name=failed_count::" <<< "$(node scripts/process-updates.js 2>&1)" | cut -d: -f4 || echo "0")
        HAS_CHANGES=$(grep "::set-output name=has_changes::" <<< "$(node scripts/process-updates.js 2>&1)" | cut -d: -f4 || echo "false")
        
        echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
        echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
        
        # Log summary
        echo "üìä Summary:"
        echo "  Processed: $PROCESSED_COUNT"
        echo "  Failed: $FAILED_COUNT"
        echo "  Has changes: $HAS_CHANGES"
        
    - name: Commit and push changes
      if: steps.process.outputs.has_changes == 'true' && steps.process.outcome == 'success'
      run: |
        echo "üíæ Committing changes..."
        
        # Configure git
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        
        # Check if there are actual changes
        if ! git diff --quiet data/parkir-data.json data/pending-updates.json; then
          # Add changed files
          git add data/parkir-data.json data/pending-updates.json
          
          # Create commit message
          COMMIT_MSG="üîÑ Auto-update parking data [$(date +'%H:%M:%S')]
          
          Processed: ${{ steps.process.outputs.processed_count || 0 }} updates
          Failed: ${{ steps.process.outputs.failed_count || 0 }} updates
          
          Generated by GitHub Actions"
          
          git commit -m "$COMMIT_MSG"
          
          # Push with retry logic
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Push attempt $i of $MAX_RETRIES"
            if git push; then
              echo "‚úÖ Successfully pushed changes"
              break
            else
              echo "üîÑ Push failed, pulling latest changes..."
              sleep 2
              git pull --rebase
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "‚ùå All push attempts failed"
              exit 1
            fi
          done
        else
          echo "‚è≠Ô∏è No changes to commit"
        fi
        
    - name: Handle failure
      if: steps.process.outcome == 'failure'
      run: |
        echo "‚ùå Update processing failed"
        echo "Check the logs for details"
        
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleanup completed"
        echo "Workflow status: ${{ job.status }}"
